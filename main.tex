\documentclass[a4paper,0.952pt]{article}
% -------------------------------------

% Marges de la page
\usepackage[left=1cm, right=1cm, top=1.5cm, bottom=1.5cm]{geometry}
\setlength{\parindent}{0mm}             % pas de retrait de paragraphe

\usepackage{graphics}
\usepackage{graphicx}                   % pour images *.jpg ou *.png
\usepackage{tikz, tkz-tab}
\usepackage{pst-all}
\usepackage{url}
\usepackage{amsfonts, amsmath, amssymb}
\usepackage[frenchb]{babel}             % règles françaises de typo
\usepackage{fontspec}                   % pour fontes spéciales utilisé par babel

\usepackage{color}
\definecolor{mouvement}{RGB}{74,108,212}
\definecolor{apparence}{RGB}{138,85,215}
\definecolor{sons}{RGB}{187,66,195}
\definecolor{stylo}{RGB}{14,154,108}
\definecolor{donnees}{RGB}{238,125,22}
\definecolor{evenements}{RGB}{200,131,48}
\definecolor{controle}{RGB}{225,169,26}
\definecolor{capteurs}{RGB}{44,165,226}
\definecolor{operateurs}{RGB}{92,183,18}
\definecolor{ajouterblocs}{RGB}{99,45,153}
\definecolor{flagcolor}{RGB}{63,141,21}

\newlength{\myl}
\newlength{\mylen}
\newcounter{ctr}
\newcounter{shift}
\setcounter{shift}{0}


%##################################################
% Low level definitions
%##################################################
\newdimen\ypos
\ypos=-0.289pt              % where to draw current block
% how to calculate with dimen
% \advance\ypos by 1pt % ypos = ypos + 1
% \ypos=3\ypos         % ypos = 3 * ypos

% \blockeventbase{width}{height}{xb}
\def\blockeventbase#1#2#3{
  \def\d{0.10}
  \def\l{0.25}
  \def\yb{-0.1}
  \pscustom{%
  \psline(0,0)(0,#2)
  \psellipticarc(!1.19 #2 -0.19 add)(1.3,0.5){10}{170}
  \psline(2.6,#2)(#1,#2)(#1,0)
    (!#3 \d\space add \l\space add \d\space add 0)
    (!#3 \d\space add \l\space add \yb)
    (!#3 \d\space add \yb)
    (!#3 0)(0,0)
   \closepath
   \closedshadow
}
}
% \blockbase{width}{height}{xb}{xh}
\def\blockbase#1#2#3#4{
  \def\d{0.10}
  \def\l{0.25}
  \def\yb{-0.1}
  % \pspolygon(0,0)(!#3 0)
    % (!#3 \d\space add \yb)
    % (!#3 \d\space add \l\space add \yb)
    % (!#3 \d\space add \l\space add \d\space add 0)(#1,0)
    % (#1,#2)
    % (!#4 \d\space add \l\space add \d\space add #2)
    % (!#4 \d\space add \l\space add #2 \yb\space add)
    % (!#4 \d\space add #2 \yb\space add)
    % (#4,#2) (0,#2)
  \pspolygon(!0 1 #2 neg add)
    (!#3 1 #2 neg add)
    (!#3 \d\space add 1 #2 neg add \yb\space add)
    (!#3 \d\space add \l\space add 1 #2 neg add \yb\space add)
    (!#3 \d\space add \l\space add \d\space add 1 #2 neg add)
    (!#1 1 #2 neg add)
    (!#1 1)
    (!#4 \d\space add \l\space add \d\space add 1)
    (!#4 \d\space add \l\space add 1 \yb\space add)
    (!#4 \d\space add 1 \yb\space add)
    (!#4 1)
    (!0 1)
}

\makeatletter
\def\pst at closedshadow{%
  \addto at pscode{%
    gsave
    \psk at shadowsize \psk at shadowangle \tx at PtoC
    \tx at Shadow
    \pst at usecolor\psshadowcolor
    gsave fill grestore
    stroke
    grestore%
  }%
}
\newcommand*{\getlength}[1]{\strip@pt\dimexpr0.035146\dimexpr#1\relax\relax}
\makeatother

%##################################################
% higher level definitions
%##################################################


\makeatletter

\def\field{\@ifstar\@@field\@field}
\newcommand{\@field}[1]{%
  \psframebox*[framearc=.7,fillcolor=white,framesep=2pt]{%
    \color{black}\normalfont{\textsf{#1}}%
}}
\newcommand{\@@field}[1]{%
  \psframebox*[framearc=.7,fillcolor=white,framesep=2pt]{%
    \color{black}\normalfont{\textsf{#1}}$^\blacktriangledown$%
}}
\def\vertBlock#1#2{
  \psset{linearc=0,linestyle=none}
  \psset{fillcolor=controle,fillstyle=solid}
  \psset{shadow=true,shadowsize=1pt,shadowangle=-45}
  % \rput(-0.012,0){\pspolygon(0,-0.2)(#1,-0.2)(!#1 #2 0.2 add)(!0 #2 0.2 add)}
  \rput(0,0.289){\pspolygon(0,-0.2)(#1,-0.2)(!#1 #2 0.07 add)(!0 #2 0.07 add)}
}


%----------------------------- \blockevent{text}
\def\blockevent#1{
  \settowidth{\myl}{\bfseries#1}
  \Gscale@div\Y \ypos{1pt} % Y=ypos but without unit (graphics package)
  \psset{linearc=0.05,linestyle=none}
  \psset{fillcolor=evenements,fillstyle=solid}
  \psset{shadow=true,shadowsize=1pt}
  \rput(0,0){
    \blockeventbase{\getlength{\the\myl}}{0.711}{.51}
    \psset{shadow=false}
    \uput[0](!0 0.711 2.1 div){\color{white}\textsf{\bfseries #1}}
  }
  \advance\ypos by -0.772pt % block height + a little bit
}

\def\flag{%
\pspolygon[unit=0.9,linearc=0,linewidth=2pt,linecolor=flagcolor,linestyle=solid,fillcolor=flagcolor,fillstyle=solid](0.082,0.43)(0.2,0.95)(0.3,0.9)(0.4,0.88)(0.5,0.88)(0.7,0.92)(0.7,0.65)(0.5,0.6)(0.4,0.6)(0.3,0.65)(0.14,0.69)
}
%----------------------------- \blockFlag
\def\blockFlag{
  \Gscale@div\Y \ypos{1pt} % Y=ypos but without unit (graphics package)
  \psset{linearc=0.05,linestyle=none}
  \psset{fillcolor=evenements,fillstyle=solid}
  \psset{shadow=true,shadowsize=1pt}
  \rput(0,0){
    \blockeventbase{4}{0.711}{.51}
    \psset{shadow=false}
    \uput[0](!0 0.711 2.1 div){\color{white}\textsf{\bfseries quand \qquad est cliqué}}
    \rput(1.2,-0.25){\flag}
  }
  \advance\ypos by -0.772pt % block height + a little bit
}
%----------------------------- \blockblank{text}
\def\vertWidth{0.5}
\def\blockblank#1{
  \settowidth{\myl}{\bfseries#1}
  \Gscale@div\Y \ypos{1pt} % Y=ypos but without unit (graphics package)
  \setcounter{ctr}{\theshift}
  \loop
    \ifnum\theshift>0
      \rput(!\thectr\space -1 add \vertWidth\space 0.05 add mul \Y){\vertBlock{\vertWidth}{0.711}}
    \fi
    \addtocounter{ctr}{-1}
    \ifnum\thectr>0
  \repeat
  \psset{linearc=0.05,linestyle=solid}
  \psset{fillstyle=none}
  \psset{shadow=false,shadowsize=1pt}
  \rput(!\theshift\space \vertWidth\space 0.05 add mul \Y){
    \blockbase{\getlength{\the\myl}}{0.711}{0.5}{.51}
    \psset{shadow=false}
    \uput[0](!0 2 -0.711 add 2.1 div){\color{white}\textsf{\bfseries 1}}
  }
  \advance\ypos by -0.752pt % block height + a little bit
}
%----------------------------- \block{color}{text}
\def\block#1#2{
  \settowidth{\myl}{\bfseries#2}
  \Gscale@div\Y \ypos{1pt} % Y=ypos but without unit (graphics package)
  \setcounter{ctr}{\theshift}
  \loop
    \ifnum\theshift>0
      \rput(!\thectr\space -1 add \vertWidth\space 0.05 add mul \Y){\vertBlock{\vertWidth}{0.711}}
    \fi
    \addtocounter{ctr}{-1}
    \ifnum\thectr>0
  \repeat
  \psset{linearc=0.05,linestyle=none}
  \psset{fillcolor=#1,fillstyle=solid}
  \psset{shadow=true,shadowsize=1pt}
  \rput(!\theshift\space \vertWidth\space 0.05 add mul \Y){
    \blockbase{\getlength{\the\myl}}{0.711}{0.5}{.51}
    \psset{shadow=false}
    \uput[0](!0 2 -0.711 add 2.1 div){\color{white}\textsf{\bfseries #2}}
  }
  \advance\ypos by -0.772pt % block height + a little bit
}
%----------------------------- \blockLoop{text}
\newcounter{nbloop}
\setcounter{nbloop}{0}
\newenvironment{blockLoop}[1]{
  \settowidth{\mylen}{\bfseries#1}
  \Gscale@div\Y \ypos{1pt} % Y=ypos but without unit (graphics package)
  \setcounter{ctr}{\theshift}
  \loop
    \ifnum\theshift>0
      \rput(!\thectr\space -1 add \vertWidth\space 0.05 add mul \Y){\vertBlock{\vertWidth}{0.711}}
    \fi
    \addtocounter{ctr}{-1}
    \ifnum\thectr>0
  \repeat
  \psset{linearc=0.05,linestyle=none}
  \psset{fillcolor=controle,fillstyle=solid}
  \psset{shadow=true,shadowsize=1pt}
  \rput(!\theshift\space \vertWidth\space 0.05 add mul \Y){
    \blockbase{\getlength{\the\mylen}}{0.711}{1.05}{0.51}
    \psset{shadow=false}
    \uput[0](!0 2 -0.711 add 2.1 div){\color{white}\textsf{\bfseries #1}}
  }
  \advance\ypos by -0.772pt % block height + a little bit
  \addtocounter{shift}{1}
}{
  \Gscale@div\Y \ypos{1pt} % Y=ypos but without unit (graphics package)
  \addtocounter{shift}{-1}
  \setcounter{ctr}{\theshift}
  \loop
    \ifnum\theshift>0
      \rput(!\thectr\space -1 add \vertWidth\space 0.05 add mul \Y){\vertBlock{\vertWidth}{0.711}}
    \fi
    \addtocounter{ctr}{-1}
    \ifnum\thectr>0
  \repeat
  \psset{linearc=0.05,linestyle=none}
  \psset{fillcolor=controle,fillstyle=solid}
  \psset{shadow=true,shadowsize=1pt}
  \rput(!\theshift\space \vertWidth\space 0.05 add mul \Y){
    \blockbase{\getlength{\the\mylen}}{0.451}{0.5}{1.05}
    \psset{shadow=false}
    \rput{-90}(!\getlength{\the\mylen} -0.3 add 2 -0.451 add 2.1 div){\color{white}\textsf{$\mathbf{\Lsh}$}}
  }
  \advance\ypos by -0.512pt % block height + a little bit
  \global\ypos=\ypos
}
\makeatother




\begin{document}

\section{Introduction}

\noindent
\begin{minipage}[c]{.65\textwidth}
\begin{verbatim}
\begin{pspicture}(0,0)(4,-10)%
  \blockFlag
  \block{stylo}{mon texte super super SUPER long}
  \begin{blockLoop}{répéter indéfiniment}
    \block{stylo}{montrer\quad}
    \begin{blockLoop}{répéter \field{10} fois }
      \block{mouvement}{donner la valeur \field{0} à x }
      \block{stylo}{mon texte super long}
      \block{evenements}{le texte du bloc \field*{90}}
      \blockblank{--- caché ( pédagogie) ---}
    \end{blockLoop}
    \block{stylo}{mon texte super long}
  \end{blockLoop}
  \blockblank{--- xxxxxxxxxxxxx ---}
\end{pspicture}
\end{verbatim}
\end{minipage}% <---------------- Note the use of "%"
\begin{minipage}[c]{25\textwidth}
\begin{pspicture}(0,0)(4,-10)%
  % \blockevent{quand ce lutin est cliqué}
  \blockFlag
  \block{mouvement}{s'orienter à \field*{90} degrés}
  \block{stylo}{effacer tout }
  \block{stylo}{stylo en position d'écriture}
  \block{stylo}{mettre la taille du stylo à \field{1}}
  \begin{blockLoop}{répéter \field{240} fois }
    \begin{blockLoop}{répéter \field{4} fois }
      \block{mouvement}{avancer de \field{100} }
      \block{mouvement}{tourner de \field*{90} degrés}
      % \blockblank{--- caché ( pédagogie) ---}
    \end{blockLoop}
    \block{mouvement}{tourner de \field{1.5} degrés}
    \block{stylo}{ajouter \field{1} à la couleur du stylo}
  \end{blockLoop}
  % \blockblank{--- xxxxxxxxxxxxx ---}
\end{pspicture}
\end{minipage}



\end{document}
